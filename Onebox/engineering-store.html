<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Engineering Store Management - Onebox</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        .border-left-primary { border-left: 0.25rem solid #4e73df !important; }
        .border-left-success { border-left: 0.25rem solid #1cc88a !important; }
        .border-left-warning { border-left: 0.25rem solid #f6c23e !important; }
        .border-left-danger { border-left: 0.25rem solid #e74a3b !important; }
        .border-left-info { border-left: 0.25rem solid #36b9cc !important; }
        
        .hover-card:hover {
            transform: translateY(-2px);
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1) !important;
        }
        
        .text-xs {
            font-size: 0.7rem;
        }
        
        .text-gray-800 {
            color: #5a5c69 !important;
        }
        
        .text-gray-300 {
            color: #dddfeb !important;
        }
        
        .font-weight-bold {
            font-weight: 700 !important;
        }
        
        .nav-pills .nav-link.active {
            background-color: #4e73df;
        }
        
        .table th {
            border-top: none;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85rem;
            color: #858796;
        }
        
        .card {
            border: none;
            box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
        }
        
        .card-header {
            background-color: #f8f9fc;
            border-bottom: 1px solid #e3e6f0;
        }

        /* Maximize table width */
        .table-responsive {
            width: 100%;
        }
        
        .table {
            width: 100%;
            margin-bottom: 0;
        }
        
        .table td, .table th {
            padding: 0.75rem;
            vertical-align: middle;
        }
        
        /* Full width containers */
        .container-fluid {
            padding-left: 15px;
            padding-right: 15px;
        }
        
        /* Maximize card body */
        .card-body {
            padding: 1.5rem;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- Header -->
        <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
            <div class="container-fluid">
                <a class="navbar-brand" href="index.html">
                    <i class="fas fa-cogs me-2"></i>
                    Onebox Workspace
                </a>
                <div class="navbar-nav ms-auto">
                    <div class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user-circle me-1"></i>
                            <span id="navUserName">Loading...</span>
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="auth/logout.php"><i class="fas fa-sign-out-alt me-2"></i>Logout</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Page Header -->
        <div class="row justify-content-center mb-4">
            <div class="col-12">
                <div class="text-center">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <a href="index.html" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-2"></i>Kembali ke Workspace
                        </a>
                        <div class="text-center flex-grow-1">
                            <h1 class="display-5 mb-2">
                                <i class="fas fa-store me-2 text-info"></i>Engineering Store
                            </h1>
                            <p class="lead text-muted">Kelola inventaris dan permintaan spare part</p>
                        </div>
                        <div style="width: 200px;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="row mb-4">
            <div class="col-12">
                <ul class="nav nav-pills nav-fill justify-content-center" id="engineeringTabs" role="tablist" style="max-width: 600px; margin: 0 auto;">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="inventory-tab" data-bs-toggle="pill" data-bs-target="#inventory" type="button" role="tab">
                            <i class="fas fa-boxes me-2"></i>Inventory Management
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="requests-tab" data-bs-toggle="pill" data-bs-target="#requests" type="button" role="tab">
                            <i class="fas fa-clipboard-list me-2"></i>Spare Part Requests
                        </button>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Tab Content -->
        <div class="tab-content" id="engineeringTabContent">
            <!-- Inventory Management Tab -->
            <div class="tab-pane fade show active" id="inventory" role="tabpanel">
                <!-- Inventory Statistics -->
                <div class="row mb-4">
                    <div class="col-xl-3 col-md-6 mb-4">
                        <div class="card border-left-primary shadow h-100 py-2 hover-card">
                            <div class="card-body">
                                <div class="row no-gutters align-items-center">
                                    <div class="col mr-2">
                                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Total Items</div>
                                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalItems">0</div>
                                    </div>
                                    <div class="col-auto">
                                        <i class="fas fa-boxes fa-2x text-gray-300"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-md-6 mb-4">
                        <div class="card border-left-success shadow h-100 py-2 hover-card">
                            <div class="card-body">
                                <div class="row no-gutters align-items-center">
                                    <div class="col mr-2">
                                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">In Stock</div>
                                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="inStock">0</div>
                                    </div>
                                    <div class="col-auto">
                                        <i class="fas fa-check-circle fa-2x text-gray-300"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-md-6 mb-4">
                        <div class="card border-left-warning shadow h-100 py-2 hover-card">
                            <div class="card-body">
                                <div class="row no-gutters align-items-center">
                                    <div class="col mr-2">
                                        <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Low Stock</div>
                                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="lowStock">0</div>
                                    </div>
                                    <div class="col-auto">
                                        <i class="fas fa-exclamation-triangle fa-2x text-gray-300"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-md-6 mb-4">
                        <div class="card border-left-danger shadow h-100 py-2 hover-card">
                            <div class="card-body">
                                <div class="row no-gutters align-items-center">
                                    <div class="col mr-2">
                                        <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">Out of Stock</div>
                                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="outOfStock">0</div>
                                    </div>
                                    <div class="col-auto">
                                        <i class="fas fa-times-circle fa-2x text-gray-300"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Inventory Controls -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card shadow">
                            <div class="card-header py-3">
                                <h6 class="m-0 font-weight-bold text-primary">Inventory Controls</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                                            <input type="text" class="form-control" id="inventorySearch" placeholder="Search items..." onkeyup="filterInventory()">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <select class="form-select" id="categoryFilter" onchange="filterInventory()">
                                            <option value="">All Categories</option>
                                            <option value="Spare Parts">Spare Parts</option>
                                            <option value="Tools">Tools</option>
                                            <option value="Components">Components</option>
                                            <option value="Consumables">Consumables</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <select class="form-select" id="stockFilter" onchange="filterInventory()">
                                            <option value="">All Stock Status</option>
                                            <option value="in-stock">In Stock</option>
                                            <option value="low-stock">Low Stock</option>
                                            <option value="out-of-stock">Out of Stock</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <button class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#addItemModal">
                                            <i class="fas fa-plus me-2"></i>Add Item
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Inventory Table -->
                <div class="row">
                    <div class="col-12">
                        <div class="card shadow">
                            <div class="card-header py-3">
                                <h6 class="m-0 font-weight-bold text-primary">Inventory Items</h6>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0" id="inventoryTable">
                                        <thead class="table-light">
                                            <tr>
                                                <th style="width: 12%;">Item Code</th>
                                                <th style="width: 20%;">Item Name</th>
                                                <th style="width: 12%;">Category</th>
                                                <th style="width: 10%;">Current Stock</th>
                                                <th style="width: 10%;">Min Stock</th>
                                                <th style="width: 12%;">Location</th>
                                                <th style="width: 10%;">Unit Price</th>
                                                <th style="width: 10%;">Status</th>
                                                <th style="width: 14%;">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="inventoryTableBody">
                                            <!-- Dynamic content -->
                                        </tbody>
                                    </table>
                                </div>
                                <div id="inventoryEmptyState" class="text-center py-5" style="display: none;">
                                    <i class="fas fa-boxes fa-3x text-muted mb-3"></i>
                                    <h5 class="text-muted">No inventory items found</h5>
                                    <p class="text-muted">Add items to start managing your inventory</p>
                                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addItemModal">
                                        <i class="fas fa-plus me-2"></i>Add First Item
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Spare Part Requests Tab -->
            <div class="tab-pane fade" id="requests" role="tabpanel">
                <!-- Request Statistics -->
                <div class="row mb-4">
                    <div class="col-xl-3 col-md-6 mb-4">
                        <div class="card border-left-warning shadow h-100 py-2 hover-card">
                            <div class="card-body">
                                <div class="row no-gutters align-items-center">
                                    <div class="col mr-2">
                                        <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Pending</div>
                                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="pendingRequests">0</div>
                                    </div>
                                    <div class="col-auto">
                                        <i class="fas fa-clock fa-2x text-gray-300"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-md-6 mb-4">
                        <div class="card border-left-info shadow h-100 py-2 hover-card">
                            <div class="card-body">
                                <div class="row no-gutters align-items-center">
                                    <div class="col mr-2">
                                        <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Processing</div>
                                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="processingRequests">0</div>
                                    </div>
                                    <div class="col-auto">
                                        <i class="fas fa-cog fa-2x text-gray-300"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-md-6 mb-4">
                        <div class="card border-left-success shadow h-100 py-2 hover-card">
                            <div class="card-body">
                                <div class="row no-gutters align-items-center">
                                    <div class="col mr-2">
                                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Fulfilled</div>
                                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="fulfilledRequests">0</div>
                                    </div>
                                    <div class="col-auto">
                                        <i class="fas fa-check-circle fa-2x text-gray-300"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-md-6 mb-4">
                        <div class="card border-left-danger shadow h-100 py-2 hover-card">
                            <div class="card-body">
                                <div class="row no-gutters align-items-center">
                                    <div class="col mr-2">
                                        <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">Rejected</div>
                                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="rejectedRequests">0</div>
                                    </div>
                                    <div class="col-auto">
                                        <i class="fas fa-times-circle fa-2x text-gray-300"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Request Controls -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card shadow">
                            <div class="card-header py-3">
                                <h6 class="m-0 font-weight-bold text-primary">Request Controls</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                                            <input type="text" class="form-control" id="requestSearch" placeholder="Search requests..." onkeyup="filterRequests()">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <select class="form-select" id="requestStatusFilter" onchange="filterRequests()">
                                            <option value="">All Status</option>
                                            <option value="Pending">Pending</option>
                                            <option value="Processing">Processing</option>
                                            <option value="Fulfilled">Fulfilled</option>
                                            <option value="Rejected">Rejected</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <select class="form-select" id="requestPriorityFilter" onchange="filterRequests()">
                                            <option value="">All Priority</option>
                                            <option value="Low">Low</option>
                                            <option value="Medium">Medium</option>
                                            <option value="High">High</option>
                                            <option value="Critical">Critical</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <button class="btn btn-success w-100" onclick="refreshRequests()">
                                            <i class="fas fa-sync me-2"></i>Refresh
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Requests Table -->
                <div class="row">
                    <div class="col-12">
                        <div class="card shadow">
                            <div class="card-header py-3">
                                <h6 class="m-0 font-weight-bold text-primary">Spare Part Requests from Maintenance</h6>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0" id="requestsTable">
                                        <thead class="table-light">
                                            <tr>
                                                <th style="width: 12%;">Request ID</th>
                                                <th style="width: 12%;">PBK Ticket</th>
                                                <th style="width: 15%;">Requested By</th>
                                                <th style="width: 18%;">Item Requested</th>
                                                <th style="width: 8%;">Quantity</th>
                                                <th style="width: 10%;">Priority</th>
                                                <th style="width: 12%;">Request Date</th>
                                                <th style="width: 8%;">Status</th>
                                                <th style="width: 15%;">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="requestsTableBody">
                                            <!-- Dynamic content -->
                                        </tbody>
                                    </table>
                                </div>
                                <div id="requestsEmptyState" class="text-center py-5" style="display: none;">
                                    <i class="fas fa-clipboard-list fa-3x text-muted mb-3"></i>
                                    <h5 class="text-muted">No spare part requests found</h5>
                                    <p class="text-muted">Requests from maintenance will appear here</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Item Modal -->
    <div class="modal fade" id="addItemModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="itemModalTitle">
                        <i class="fas fa-plus me-2"></i>Add New Item
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="itemForm" novalidate>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label"><i class="fas fa-barcode me-1"></i>Item Code *</label>
                                    <input type="text" class="form-control" id="itemCode" required>
                                    <div class="invalid-feedback">Please provide a valid item code.</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label"><i class="fas fa-tag me-1"></i>Item Name *</label>
                                    <input type="text" class="form-control" id="itemName" required>
                                    <div class="invalid-feedback">Please provide a valid item name.</div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label"><i class="fas fa-list me-1"></i>Category *</label>
                                    <select class="form-select" id="itemCategory" required>
                                        <option value="">Select Category</option>
                                        <option value="Spare Parts">Spare Parts</option>
                                        <option value="Tools">Tools</option>
                                        <option value="Components">Components</option>
                                        <option value="Consumables">Consumables</option>
                                    </select>
                                    <div class="invalid-feedback">Please select a category.</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label"><i class="fas fa-map-marker-alt me-1"></i>Location</label>
                                    <input type="text" class="form-control" id="itemLocation" placeholder="e.g., Rack A-1-2">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label"><i class="fas fa-boxes me-1"></i>Current Stock *</label>
                                    <input type="number" class="form-control" id="currentStock" min="0" required>
                                    <div class="invalid-feedback">Please provide a valid stock number.</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label"><i class="fas fa-exclamation-triangle me-1"></i>Minimum Stock *</label>
                                    <input type="number" class="form-control" id="minStock" min="0" required>
                                    <div class="invalid-feedback">Please provide a valid minimum stock number.</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Unit Price</label>
                                    <input type="number" class="form-control" id="unitPrice" min="0" step="0.01">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label"><i class="fas fa-arrow-up me-1"></i>Maximum Stock</label>
                                    <input type="number" class="form-control" id="maxStock" min="0">
                                </div>
                            </div>
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label class="form-label"><i class="fas fa-truck me-1"></i>Supplier</label>
                                    <input type="text" class="form-control" id="itemSupplier" placeholder="Supplier name...">
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label"><i class="fas fa-align-left me-1"></i>Description</label>
                            <textarea class="form-control" id="itemDescription" rows="3" placeholder="Item description..."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Cancel
                    </button>
                    <button type="button" class="btn btn-primary" onclick="saveItem()">
                        <i class="fas fa-save me-2"></i>Save Item
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Request Detail Modal -->
    <div class="modal fade" id="requestDetailModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-info-circle me-2"></i>Request Details
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="requestDetailContent">
                    <!-- Dynamic content -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Close
                    </button>
                    <button type="button" class="btn btn-success" id="fulfillRequestBtn" onclick="fulfillRequest()" data-request-id="">
                        <i class="fas fa-check me-2"></i>Fulfill Request
                    </button>
                    <button type="button" class="btn btn-danger" id="rejectRequestBtn" onclick="rejectRequest()" data-request-id="">
                        <i class="fas fa-times me-2"></i>Reject Request
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Stock Adjustment Modal -->
    <div class="modal fade" id="stockAdjustmentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-edit me-2"></i>Adjust Stock
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="stockAdjustmentForm">
                        <div class="mb-3">
                            <label class="form-label">Item: <span id="adjustItemName"></span></label>
                            <input type="hidden" id="adjustItemId">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Current Stock: <span id="adjustCurrentStock"></span></label>
                        </div>
                        <div class="mb-3">
                            <label class="form-label"><i class="fas fa-exchange-alt me-1"></i>Adjustment Type</label>
                            <select class="form-select" id="adjustmentType" required>
                                <option value="">Select Type</option>
                                <option value="add">Add Stock</option>
                                <option value="remove">Remove Stock</option>
                                <option value="set">Set Stock</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label"><i class="fas fa-sort-numeric-up me-1"></i>Quantity</label>
                            <input type="number" class="form-control" id="adjustmentQuantity" min="0" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label"><i class="fas fa-comment me-1"></i>Reason</label>
                            <textarea class="form-control" id="adjustmentReason" rows="3" placeholder="Reason for stock adjustment..."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Cancel
                    </button>
                    <button type="button" class="btn btn-primary" onclick="saveStockAdjustment()">
                        <i class="fas fa-save me-2"></i>Save Adjustment
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Custom JavaScript -->
    <script>
        // Global variables
        let currentEditingId = null;
        let allInventoryData = [];

        // Session check
        function checkSession() {
            fetch('auth/check_session.php')
                .then(response => response.json())
                .then(data => {
                    if (!data.success) {
                        window.location.href = 'login.html';
                        return;
                    }
                    const role = (data.user?.role || '').toLowerCase();
                    const allowed = role === 'admin' || role === 'engineering';
                    if (!allowed) {
                        switch (role) {
                            case 'user':
                                window.location.href = 'user-production.html';
                                break;
                            case 'maintenance':
                                window.location.href = 'maintenance.html';
                                break;
                            default:
                                window.location.href = 'index.html';
                                break;
                        }
                        return;
                    }
                    const navUserNameEl = document.getElementById('navUserName');
                    if (navUserNameEl) {
                        const displayName = data.user?.full_name || data.user?.username || 'User';
                        navUserNameEl.textContent = `${displayName} (${data.user?.role})`;
                    }
                })
                .catch(error => {
                    console.error('Session check error:', error);
                    window.location.href = 'login.html';
                });
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            checkSession();
            loadInventoryData();
            loadRequestsData();
            loadInventoryTable();
            loadRequestsTable();
            
            // Set up tab event listeners
            document.getElementById('requests-tab').addEventListener('shown.bs.tab', function() {
                loadRequestsTable();
            });
            
            // Reset form when modal is closed
            document.getElementById('addItemModal').addEventListener('hidden.bs.modal', function() {
                resetItemForm();
            });
        });

        // Helper functions untuk status badge
        function getStockStatusColor(item) {
            if (item.current_stock === 0) return 'danger';
            if (item.current_stock <= item.minimum_stock) return 'warning';
            return 'success';
        }

        function getStockStatus(item) {
            if (item.current_stock === 0) return 'Out of Stock';
            if (item.current_stock <= item.minimum_stock) return 'Low Stock';
            return 'In Stock';
        }

        function getPriorityColor(priority) {
            switch(priority?.toLowerCase()) {
                case 'critical': return 'danger';
                case 'high': return 'warning';
                case 'medium': return 'info';
                case 'low': return 'secondary';
                default: return 'secondary';
            }
        }

        function getStatusColor(status) {
            switch(status?.toLowerCase()) {
                case 'pending': return 'warning';
                case 'processing': return 'info';
                case 'fulfilled': return 'success';
                case 'rejected': return 'danger';
                default: return 'secondary';
            }
        }

        // Load inventory data from database
        function loadInventoryData() {
            fetch('api/inventory_stats.php')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('totalItems').textContent = data.total_items || 0;
                        document.getElementById('inStock').textContent = data.in_stock || 0;
                        document.getElementById('lowStock').textContent = data.low_stock || 0;
                        document.getElementById('outOfStock').textContent = data.out_of_stock || 0;
                    } else {
                        console.error('Error fetching inventory stats:', data.error);
                    }
                })
                .catch(error => {
                    console.error('Error fetching inventory stats:', error);
                });
        }
        
        // Load requests data from database
        function loadRequestsData() {
            fetch('api/spare_part_requests_stats.php')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('pendingRequests').textContent = data.pending || 0;
                        document.getElementById('processingRequests').textContent = data.processing || 0;
                        document.getElementById('fulfilledRequests').textContent = data.fulfilled || 0;
                        document.getElementById('rejectedRequests').textContent = data.rejected || 0;
                    } else {
                        console.error('Error fetching requests stats:', data.error);
                    }
                })
                .catch(error => {
                    console.error('Error fetching requests stats:', error);
                });
        }
        
        // Load inventory table from database
        function loadInventoryTable() {
            // Add cache busting parameter
            const timestamp = new Date().getTime();
            
            fetch(`api/get_inventory.php?t=${timestamp}`, {
                method: 'GET',
                headers: {
                    'Cache-Control': 'no-cache',
                    'Pragma': 'no-cache'
                }
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(result => {
                    console.log('Inventory API Response:', result); // Debug log
                    
                    const tbody = document.getElementById('inventoryTableBody');
                    const emptyState = document.getElementById('inventoryEmptyState');
                    const table = document.getElementById('inventoryTable');
                    
                    const data = result.success ? result.data : [];
                    allInventoryData = data; // Store for filtering
                    
                    console.log('Inventory Data Count:', data.length); // Debug log
                    
                    if (data.length === 0) {
                        table.style.display = 'none';
                        emptyState.style.display = 'block';
                    } else {
                        tbody.innerHTML = data.map(item => `
                            <tr>
                                <td><span class="fw-bold">${item.item_code}</span></td>
                                <td>${item.item_name}</td>
                                <td><span class="badge bg-light text-dark">${item.category}</span></td>
                                <td><span class="fw-bold">${item.current_stock}</span></td>
                                <td>${item.minimum_stock}</td>
                                <td>${item.location || '-'}</td>
                                <td>${(parseFloat(item.unit_price) || 0).toFixed(2)}</td>
                                <td><span class="badge bg-${getStockStatusColor(item)}">${getStockStatus(item)}</span></td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button class="btn btn-outline-primary" onclick="editItem(${item.id})" title="Edit">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-outline-info" onclick="adjustStock(${item.id})" title="Adjust Stock">
                                            <i class="fas fa-exchange-alt"></i>
                                        </button>
                                        <button class="btn btn-outline-danger" onclick="deleteItem(${item.id})" title="Delete">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `).join('');
                        table.style.display = 'block';
                        emptyState.style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('Error loading inventory:', error);
                    const tbody = document.getElementById('inventoryTableBody');
                    const emptyState = document.getElementById('inventoryEmptyState');
                    const table = document.getElementById('inventoryTable');
                    
                    tbody.innerHTML = '';
                    table.style.display = 'none';
                    emptyState.style.display = 'block';
                });
        }
        
        // Load requests table from database
        function loadRequestsTable() {
            fetch('api/get_spare_part_requests.php')
                .then(response => response.json())
                .then(result => {
                    const tbody = document.getElementById('requestsTableBody');
                    const emptyState = document.getElementById('requestsEmptyState');
                    const table = document.getElementById('requestsTable');
                    
                    const data = result.success ? result.data : [];
                    
                    if (data.length === 0) {
                        table.style.display = 'none';
                        emptyState.style.display = 'block';
                    } else {
                        tbody.innerHTML = data.map(request => `
                            <tr>
                                <td><span class="fw-bold">${request.request_number}</span></td>
                                <td>${request.pbk_number || '-'}</td>
                                <td>${request.requested_by_name}</td>
                                <td>${request.item_name}</td>
                                <td><span class="fw-bold">${request.quantity_requested}</span></td>
                                <td><span class="badge bg-${getPriorityColor(request.urgency)}">${request.urgency}</span></td>
                                <td>${new Date(request.created_at).toLocaleDateString()}</td>
                                <td><span class="badge bg-${getStatusColor(request.status)}">${request.status}</span></td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button class="btn btn-outline-info" onclick="viewRequestDetails(${request.id})" title="View Details">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        ${request.status === 'Pending' ? `
                                            <button class="btn btn-outline-success" onclick="approveRequest(${request.id})" title="Approve">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            <button class="btn btn-outline-danger" onclick="rejectRequestFromTable(${request.id})" title="Reject">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        ` : ''}
                                    </div>
                                </td>
                            </tr>
                        `).join('');
                        table.style.display = 'block';
                        emptyState.style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('Error loading requests:', error);
                });
        }

        // Form validation
        function validateForm() {
            const form = document.getElementById('itemForm');
            const inputs = form.querySelectorAll('input[required], select[required]');
            let isValid = true;

            inputs.forEach(input => {
                if (!input.value.trim()) {
                    input.classList.add('is-invalid');
                    isValid = false;
                } else {
                    input.classList.remove('is-invalid');
                    input.classList.add('is-valid');
                }
            });

            return isValid;
        }

        // Reset form
        function resetItemForm() {
            const form = document.getElementById('itemForm');
            form.reset();
            form.querySelectorAll('.is-valid, .is-invalid').forEach(el => {
                el.classList.remove('is-valid', 'is-invalid');
            });
            currentEditingId = null;
            document.getElementById('itemModalTitle').innerHTML = '<i class="fas fa-plus me-2"></i>Add New Item';
        }

        // Save item function
        function saveItem() {
            const form = document.getElementById('itemForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            const itemData = {
                item_code: document.getElementById('itemCode').value,
                item_name: document.getElementById('itemName').value,
                category: document.getElementById('itemCategory').value,
                description: document.getElementById('itemDescription').value,
                current_stock: parseInt(document.getElementById('currentStock').value),
                minimum_stock: parseInt(document.getElementById('minStock').value),
                maximum_stock: parseInt(document.getElementById('maxStock').value) || 0,
                unit_price: parseFloat(document.getElementById('unitPrice').value) || 0,
                location: document.getElementById('itemLocation').value,
                supplier: document.getElementById('itemSupplier').value
            };
            
            // Show loading
            Swal.fire({
                title: 'Saving...',
                text: 'Please wait while we save the item',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            const url = currentEditingId ? 'api/update_inventory_item.php' : 'api/add_inventory_item.php';
            if (currentEditingId) {
                itemData.id = currentEditingId;
            }

            // Send to API
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(itemData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('API Response:', data); // Debug log
                
                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Success!',
                        text: currentEditingId ? 'Item berhasil diupdate!' : 'Item berhasil ditambahkan ke inventory!',
                        timer: 2000,
                        showConfirmButton: false
                    });
                    
                    // Close modal and reset form
                    bootstrap.Modal.getInstance(document.getElementById('addItemModal')).hide();
                    resetItemForm();
                    
                    // Add delay before refresh to ensure database commit
                    setTimeout(() => {
                        // Refresh data with cache busting
                        loadInventoryData();
                        loadInventoryTable();
                        
                        // Force reload after short delay
                        setTimeout(() => {
                            loadInventoryTable();
                        }, 500);
                    }, 300);
                } else {
                    console.error('API Error:', data.error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Error!',
                        text: data.error || 'Gagal menyimpan item'
                    });
                }
            })
            .catch(error => {
                console.error('Fetch Error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error!',
                    text: 'Terjadi kesalahan saat menyimpan item: ' + error.message
                });
            });
        }

        // Edit item function
        function editItem(id) {
            const item = allInventoryData.find(item => item.id == id);
            if (!item) return;

            currentEditingId = id;
            
            // Populate form
            document.getElementById('itemCode').value = item.item_code;
            document.getElementById('itemName').value = item.item_name;
            document.getElementById('itemCategory').value = item.category;
            document.getElementById('itemDescription').value = item.description || '';
            document.getElementById('currentStock').value = item.current_stock;
            document.getElementById('minStock').value = item.minimum_stock;
            document.getElementById('maxStock').value = item.maximum_stock || '';
            document.getElementById('unitPrice').value = item.unit_price || '';
            document.getElementById('itemLocation').value = item.location || '';
            document.getElementById('itemSupplier').value = item.supplier || '';

            // Update modal title
            document.getElementById('itemModalTitle').innerHTML = '<i class="fas fa-edit me-2"></i>Edit Item';

            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('addItemModal'));
            modal.show();
        }

        // Delete item function
        function deleteItem(id) {
            const item = allInventoryData.find(item => item.id == id);
            if (!item) return;

            Swal.fire({
                title: 'Are you sure?',
                text: `Do you want to delete "${item.item_name}"?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Yes, delete it!'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch('api/delete_inventory_item.php', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ id: id })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            Swal.fire(
                                'Deleted!',
                                'Item has been deleted.',
                                'success'
                            );

                            // Refresh data
                            loadInventoryData();
                            loadInventoryTable();
                        } else {
                            Swal.fire(
                                'Error!',
                                data.error || 'Failed to delete item.',
                                'error'
                            );
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        Swal.fire(
                            'Error!',
                            'An error occurred while deleting the item.',
                            'error'
                        );
                    });
                }
            });
        }

        // Stock adjustment function
        function adjustStock(id) {
            const item = allInventoryData.find(item => item.id == id);
            if (!item) return;

            document.getElementById('adjustItemName').textContent = item.item_name;
            document.getElementById('adjustItemId').value = item.id;
            document.getElementById('adjustCurrentStock').textContent = item.current_stock;

            const modal = new bootstrap.Modal(document.getElementById('stockAdjustmentModal'));
            modal.show();
        }

        // Save stock adjustment function
        function saveStockAdjustment() {
            const itemId = document.getElementById('adjustItemId').value;
            const adjustmentType = document.getElementById('adjustmentType').value;
            const quantity = parseInt(document.getElementById('adjustmentQuantity').value);
            const reason = document.getElementById('adjustmentReason').value;

            if (!adjustmentType || isNaN(quantity) || quantity < 0) {
                Swal.fire({
                    icon: 'error',
                    title: 'Invalid Input!',
                    text: 'Please provide valid adjustment details.'
                });
                return;
            }

            const adjustmentData = {
                item_id: itemId,
                adjustment_type: adjustmentType,
                quantity: quantity,
                reason: reason
            };

            fetch('api/adjust_stock.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(adjustmentData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Stock Adjusted!',
                        text: `Stock has been updated successfully`,
                        timer: 2000,
                        showConfirmButton: false
                    });

                    bootstrap.Modal.getInstance(document.getElementById('stockAdjustmentModal')).hide();
                    document.getElementById('stockAdjustmentForm').reset();

                    // Refresh data
                    loadInventoryData();
                    loadInventoryTable();
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error!',
                        text: data.error || 'Failed to adjust stock.'
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error!',
                    text: 'An error occurred while adjusting stock.'
                });
            });
        }

        // Filter functions
        function filterInventory() {
            const searchTerm = document.getElementById('inventorySearch').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilter').value;
            const stockFilter = document.getElementById('stockFilter').value;

            let filteredData = allInventoryData.filter(item => {
                const matchesSearch = item.item_name.toLowerCase().includes(searchTerm) || 
                                    item.item_code.toLowerCase().includes(searchTerm);
                const matchesCategory = !categoryFilter || item.category === categoryFilter;
                
                let matchesStock = true;
                if (stockFilter === 'in-stock') {
                    matchesStock = item.current_stock > item.minimum_stock;
                } else if (stockFilter === 'low-stock') {
                    matchesStock = item.current_stock > 0 && item.current_stock <= item.minimum_stock;
                } else if (stockFilter === 'out-of-stock') {
                    matchesStock = item.current_stock === 0;
                }

                return matchesSearch && matchesCategory && matchesStock;
            });

            // Update table with filtered data
            const tbody = document.getElementById('inventoryTableBody');
            tbody.innerHTML = filteredData.map(item => `
                <tr>
                    <td><span class="fw-bold">${item.item_code}</span></td>
                    <td>${item.item_name}</td>
                    <td><span class="badge bg-light text-dark">${item.category}</span></td>
                    <td><span class="fw-bold">${item.current_stock}</span></td>
                    <td>${item.minimum_stock}</td>
                    <td>${item.location || '-'}</td>
                    <td>$${(item.unit_price || 0).toFixed(2)}</td>
                    <td><span class="badge bg-${getStockStatusColor(item)}">${getStockStatus(item)}</span></td>
                    <td>
                        <div class="btn-group btn-group-sm" role="group">
                            <button class="btn btn-outline-primary" onclick="editItem(${item.id})" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-outline-info" onclick="adjustStock(${item.id})" title="Adjust Stock">
                                <i class="fas fa-exchange-alt"></i>
                            </button>
                            <button class="btn btn-outline-danger" onclick="deleteItem(${item.id})" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // Request functions
        function viewRequestDetails(id) {
            fetch(`api/get_spare_part_requests.php`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const request = data.data.find(r => r.id == id);
                        if (request) {
                            // Show request details in modal or alert
                            Swal.fire({
                                title: 'Request Details',
                                html: `
                                    <div class="text-start">
                                        <p><strong>Request Number:</strong> ${request.request_number}</p>
                                        <p><strong>Item:</strong> ${request.item_name}</p>
                                        <p><strong>Quantity:</strong> ${request.quantity_requested}</p>
                                        <p><strong>Urgency:</strong> ${request.urgency}</p>
                                        <p><strong>Requested By:</strong> ${request.requested_by_name}</p>
                                        <p><strong>Date:</strong> ${new Date(request.created_at).toLocaleDateString()}</p>
                                        <p><strong>Status:</strong> ${request.status}</p>
                                        <p><strong>Justification:</strong> ${request.justification || 'N/A'}</p>
                                        ${request.notes ? `<p><strong>Notes:</strong> ${request.notes}</p>` : ''}
                                    </div>
                                `,
                                width: '600px'
                            });
                        }
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    Swal.fire('Error', 'Failed to load request details', 'error');
                });
        }

        function approveRequest(id) {
            Swal.fire({
                title: 'Approve Request?',
                text: 'Are you sure you want to approve this spare part request?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Yes, Approve',
                cancelButtonText: 'Cancel'
            }).then((result) => {
                if (result.isConfirmed) {
                    updateRequestStatus(id, 'approve');
                }
            });
        }

        function rejectRequestFromTable(id) {
            Swal.fire({
                title: 'Reject Request',
                input: 'textarea',
                inputLabel: 'Rejection Reason',
                inputPlaceholder: 'Please provide a reason for rejection...',
                inputValidator: (value) => {
                    if (!value) {
                        return 'You need to provide a reason!';
                    }
                },
                showCancelButton: true,
                confirmButtonText: 'Reject',
                cancelButtonText: 'Cancel'
            }).then((result) => {
                if (result.isConfirmed) {
                    updateRequestStatus(id, 'reject', result.value);
                }
            });
        }

        function fulfillRequest() {
            // This function is called from modal, get the current request ID
            const requestId = document.getElementById('fulfillRequestBtn').dataset.requestId;
            if (!requestId) {
                Swal.fire('Error', 'No request selected', 'error');
                return;
            }
            
            Swal.fire({
                title: 'Fulfill Request?',
                text: 'This will deduct the items from inventory. Are you sure?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Yes, Fulfill',
                cancelButtonText: 'Cancel'
            }).then((result) => {
                if (result.isConfirmed) {
                    updateRequestStatus(requestId, 'fulfill');
                }
            });
        }

        function rejectRequest() {
            // This function is called from modal, get the current request ID
            const requestId = document.getElementById('rejectRequestBtn').dataset.requestId;
            if (!requestId) {
                Swal.fire('Error', 'No request selected', 'error');
                return;
            }
            
            Swal.fire({
                title: 'Reject Request',
                input: 'textarea',
                inputLabel: 'Rejection Reason',
                inputPlaceholder: 'Please provide a reason for rejection...',
                inputValidator: (value) => {
                    if (!value) {
                        return 'You need to provide a reason!';
                    }
                },
                showCancelButton: true,
                confirmButtonText: 'Reject',
                cancelButtonText: 'Cancel'
            }).then((result) => {
                if (result.isConfirmed) {
                    updateRequestStatus(requestId, 'reject', result.value);
                }
            });
        }

        // Helper function to update request status
        function updateRequestStatus(requestId, action, reason = null) {
            const requestData = {
                request_id: requestId,
                action: action
            };
            
            if (reason) {
                requestData.reason = reason;
            }
            
            fetch('api/update_spare_part_request.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire('Success', data.message, 'success');
                    // Refresh the requests table
                    loadRequestsData();
                    loadRequestsTable();
                    
                    // Close modal if open
                    const modal = bootstrap.Modal.getInstance(document.getElementById('requestDetailModal'));
                    if (modal) {
                        modal.hide();
                    }
                } else {
                    Swal.fire('Error', data.message, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire('Error', 'Failed to update request status', 'error');
            });
        }

        function filterRequests() {
            // Placeholder for request filtering functionality
            console.log('Filter requests');
        }

        function refreshRequests() {
            loadRequestsData();
            loadRequestsTable();
            
            Swal.fire({
                icon: 'success',
                title: 'Refreshed!',
                text: 'Request data has been updated.',
                timer: 1500,
                showConfirmButton: false
            });
        }
    </script>
</body>
</html>